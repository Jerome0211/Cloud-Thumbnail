<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Thumbnail Service</title>
    <style>
        :root { --primary-color: #0069ff; --bg-color: #f3f4f6; --secondary-color: #6b7280; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: #333; margin: 0; padding: 40px 20px; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        h1, h2 { text-align: center; color: #111; }
        p.subtitle { text-align: center; color: #666; margin-bottom: 30px; }

        /* Auth Section */
        #authSection { border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 30px; text-align: center; }
        .auth-inputs { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        
        /* Form Styling */
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; }
        input[type="file"], input[type="text"], input[type="password"], input[type="number"], select { 
            padding: 10px; border: 1px solid #ccc; border-radius: 8px; width: 100%; box-sizing: border-box; 
        }
        input[type="file"] { border: 2px dashed #ccc; background: #fafafa; }
        
        .resize-options { display: flex; gap: 20px; background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; margin-top: 10px; }
        .radio-group { display: flex; align-items: center; gap: 5px; }
        
        .dynamic-inputs { margin-top: 15px; }
        .custom-dimensions { display: none; gap: 10px; align-items: center; }
        
        button { background-color: var(--primary-color); color: white; border: none; padding: 12px 20px; font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; transition: opacity 0.3s; }
        button:hover { opacity: 0.9; }
        button:disabled { background-color: #a0c4ff; cursor: not-allowed; }
        .btn-full { width: 100%; margin-top: 15px; }
        .btn-secondary { background-color: var(--secondary-color); }

        /* Gallery Section */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-top: 50px; border-top: 2px solid #eee; padding-top: 20px; }
        #gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .thumbnail-card { border: 1px solid #eee; padding: 10px; border-radius: 8px; text-align: center; background: #fafafa; transition: transform 0.2s; }
        .thumbnail-card:hover { transform: translateY(-5px); }
        .thumbnail-card img { max-width: 100%; height: auto; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 10px; cursor: pointer;}
        .metadata { font-size: 11px; color: #555; text-align: left; background: #fff; padding: 8px; border-radius: 4px; border: 1px solid #eee;}
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>üñºÔ∏è Cloud Thumbnail Service</h1>
    <p class="subtitle">Securely resize and store your images in the cloud</p>

    <div id="authSection">
        <div id="loginForm">
            <label>Enter Username to Sign In / Sign Up</label>
            <div class="auth-inputs">
                <input type="text" id="username" placeholder="Username (e.g. user123)" style="width: 250px;">
                <button onclick="handleLogin()">Login</button>
            </div>
            <p style="font-size: 12px; color: #888;">Note: Any name works for this demo version</p>
        </div>
        <div id="userInfo" class="hidden">
            <span>Welcome, <strong id="displayUser"></strong>!</span>
            <button onclick="handleLogout()" class="btn-secondary" style="padding: 5px 10px; font-size: 12px; margin-left: 10px;">Logout</button>
        </div>
    </div>

    <div id="mainContent" class="hidden">
        <form id="uploadForm">
            <div class="form-group">
                <label>Upload Images (Multiple supported)</label>
                <input type="file" id="imageFiles" accept="image/*" multiple required>
            </div>

            <div class="form-group">
                <label>Resize Strategy</label>
                <div class="resize-options">
                    <div class="radio-group">
                        <input type="radio" id="modePreset" name="resizeMode" value="preset" checked>
                        <label for="modePreset">Presets</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" id="modeCustom" name="resizeMode" value="custom">
                        <label for="modeCustom">Custom Dimensions</label>
                    </div>
                </div>

                <div class="dynamic-inputs" id="presetInput">
                    <select id="presetSize">
                        <option value="small">Small (150x150)</option>
                        <option value="medium">Medium (300x300)</option>
                        <option value="large">Large (600x600)</option>
                    </select>
                </div>

                <div class="dynamic-inputs custom-dimensions" id="customInput">
                    <input type="number" id="customWidth" placeholder="Width (px)" min="1">
                    <span>‚úï</span>
                    <input type="number" id="customHeight" placeholder="Height (px)" min="1">
                </div>
            </div>

            <button type="submit" id="submitBtn" class="btn-full">Generate Cloud Thumbnails üöÄ</button>
        </form>

        <div class="section-header">
            <h2>Your Cloud Gallery</h2>
            <button onclick="loadMyGallery()" class="btn-secondary" style="font-size: 12px;">üîÑ Refresh Gallery</button>
        </div>
        <div id="gallery">
            </div>
    </div>
</div>

<script>
    const API_BASE_URL = ""; // Empty string assumes frontend and backend are on the same domain
    let token = localStorage.getItem("access_token");

    // UI Toggle Logic
    const modePresetBtn = document.getElementById('modePreset');
    const modeCustomBtn = document.getElementById('modeCustom');
    const presetInputDiv = document.getElementById('presetInput');
    const customInputDiv = document.getElementById('customInput');

    modePresetBtn.addEventListener('change', () => { presetInputDiv.style.display = 'block'; customInputDiv.style.display = 'none'; });
    modeCustomBtn.addEventListener('change', () => { presetInputDiv.style.display = 'none'; customInputDiv.style.display = 'flex'; });

    // Initialization
    window.onload = () => {
        if (token) {
            showMainContent(localStorage.getItem("username"));
            loadMyGallery();
        }
    };

    async function handleLogin() {
        const username = document.getElementById('username').value;
        if (!username) return alert("Please enter a username");

        const formData = new URLSearchParams();
        formData.append("username", username);
        formData.append("password", "default"); // Dummy password

        try {
            const response = await fetch(`${API_BASE_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });
            const data = await response.json();
            token = data.access_token;
            localStorage.setItem("access_token", token);
            localStorage.setItem("username", username);
            showMainContent(username);
            loadMyGallery();
        } catch (err) {
            alert("Login failed: " + err.message);
        }
    }

    function handleLogout() {
        localStorage.clear();
        location.reload();
    }

    function showMainContent(username) {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('userInfo').classList.remove('hidden');
        document.getElementById('displayUser').innerText = username;
        document.getElementById('mainContent').classList.remove('hidden');
    }

    async function loadMyGallery() {
        const galleryDiv = document.getElementById('gallery');
        try {
            const response = await fetch(`${API_BASE_URL}/thumbnails/me`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.status === 401) return handleLogout();
            
            const data = await response.json();
            galleryDiv.innerHTML = data.length === 0 ? "<p style='grid-column: 1/-1; text-align:center; color:#888;'>No images found. Upload something!</p>" : "";
            
            data.forEach(item => renderThumbnail(item, galleryDiv));
        } catch (err) {
            console.error("Failed to load gallery:", err);
        }
    }

    function renderThumbnail(item, container) {
        const card = document.createElement('div');
        card.className = 'thumbnail-card';
        card.innerHTML = `
            <img src="${item.url}" onclick="window.open('${item.url}', '_blank')" title="Click to view full size">
            <div class="metadata">
                <strong>Name:</strong> ${item.original_filename}<br>
                <strong>Size:</strong> ${item.width} x ${item.height} px<br>
                <strong>ID:</strong> ${item.id.substring(0,8)}...
            </div>
        `;
        container.prepend(card);
    }

    // Upload Logic
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const files = document.getElementById('imageFiles').files;
        const submitBtn = document.getElementById('submitBtn');

        submitBtn.disabled = true;
        submitBtn.innerText = "Uploading to Cloud... ‚è≥";

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) { formData.append("files", files[i]); }

        if (document.getElementById('modePreset').checked) {
            formData.append("preset", document.getElementById('presetSize').value);
        } else {
            formData.append("width", document.getElementById('customWidth').value);
            formData.append("height", document.getElementById('customHeight').value);
        }

        try {
            const response = await fetch(`${API_BASE_URL}/thumbnails/`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            if (!response.ok) throw new Error("Upload failed");

            const results = await response.json();
            loadMyGallery(); // Refresh after upload
            alert(`Successfully processed ${results.length} image(s)!`);
        } catch (error) {
            alert(`Error: ${error.message}`);
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = "Generate Cloud Thumbnails üöÄ";
        }
    });
</script>

</body>
</html>